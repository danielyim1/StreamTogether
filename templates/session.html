<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Session</title>

    <!-- jQuery (needed for $) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Clipboard.js (needed for new Clipboard(...)) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Your custom CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/mystyle.css') }}">
</head>
<body>
    <div class="container mt-3">
        <h2 id="room-title"></h2>

        <div id="join-content">
            <div class="form-group">
                <label for="client-id">Enter your name:</label>
                <input type="text" id="client-id" class="form-control">
            </div>
            <button id="join" class="btn btn-primary">Join Room</button>
        </div>

        <div id="content">
            <div class="form-group">
                <label for="link">YouTube Link:</label>
                <input type="text" id="link" class="form-control">
            </div>
            <button id="submit" class="btn btn-success">Set Video</button>
            <button id="home" class="btn btn-secondary">Home</button>
        </div>

        <div id="video" style="width:100%; height:500px;"></div>

        <div id="joined-names" class="mt-3"></div>

        <div class="form-group mt-2">
            <input type="text" id="post-shortlink" class="form-control" readonly>
            <button id="copy-button" class="btn btn-info mt-1" data-clipboard-target="#post-shortlink">Copy Link</button>
        </div>
    </div>

    <script type="text/javascript">
        // ====== Your existing session.js logic goes here ======
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const sessionId = urlParams.get('id').toUpperCase();
        var joinedNames = [];
        var heartbeatHandled = false;
        var baseUrl = location.port 
            ? "http://" + document.domain + ":" + location.port 
            : "https://" + document.domain;
        var clientId = "";

        function getRandomName() {
            function capFirst(string) { return string.charAt(0).toUpperCase() + string.slice(1); }
            function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min)) + min; }
            var name1 = ["abandoned","able","absolute","adorable","adventurous","academic","acceptable"];
            var name2 = ["people","history","way","art","world","information"];
            return capFirst(name1[getRandomInt(0, name1.length)]) + ' ' + capFirst(name2[getRandomInt(0, name2.length)]);
        }

        function setJoinedNames() {
            $('div#joined-names').empty();
            joinedNames.forEach(id => {
                let style = id == clientId ? 'style="background-color: #28a745; border-color: #28a745; color: #fff"' : '';
                $('div#joined-names').append('<div class="alert alert-primary" ' + style + ' role="alert">' + id + '</div>');
            });
        }

        function getVideoId(url){
            var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            var match = url.match(regExp);
            return (match&&match[7].length==11)? match[7] : false;
        }

        function showVideo(show=true) {
            $('div#video')[0].style.display = show ? "block" : "none";
        }

        function showJoin(show=true) {
            $('div#join-content')[0].style.display = show ? "block" : "none";
            $('div#content')[0].style.display = show ? "none" : "block";
        }

        function setVideo() {
            const id = getVideoId($('input#link')[0].value);
            if (id) {
                showVideo(false);
                socket.emit("set_video", { sessionId: sessionId, id: id });
            } else {
                alert("Invalid YouTube URL");
            }
        }

        function uploadVideo(video_id) {
            $('input#link')[0].value = 'https://www.youtube.com/watch?v=' + video_id;
            showVideo();
            player.cueVideoById(video_id);
        }

        function getCurrentlyPlaying() {
            let state = player.getPlayerState();
            return !(state == YT.PlayerState.PAUSED || state == YT.PlayerState.CUED || state == YT.PlayerState.UNSTARTED || state == YT.PlayerState.ENDED);
        }

        function changeVideoState(data) {
            const { isPlaying, currentTime } = data;
            if (!getCurrentlyPlaying() && isPlaying)  {
                showVideo();
                player.seekTo(currentTime,true);
                player.playVideo();
            } else if (getCurrentlyPlaying() && !isPlaying) {
                showVideo();
                player.seekTo(currentTime,true);
                player.pauseVideo();
            }
        }

        function handleJoin(otherId) {
            joinedNames.push(otherId);
            setJoinedNames();
            socket.emit('send_heartbeat', {
                sessionId: sessionId,
                id: player.playerInfo.videoData.video_id,
                currentTime: player.getCurrentTime(),
                isPlaying: getCurrentlyPlaying(),
                joinedNames: joinedNames
            });
        }

        function handleLeave(otherId) {
            joinedNames = joinedNames.filter(name => name !== otherId);
            setJoinedNames();
        }

        function goHome() {
            window.location.href = baseUrl;
        }

        function joinSession() {
            clientId = $('input#client-id')[0].value;
            socket.emit('join', { sessionId: sessionId, clientId: clientId });
            showJoin(false);
            joinedNames.push(clientId);
            setJoinedNames();
            heartbeatHandled = false;
        }

        function handleHeartbeat(data) {
            if (!heartbeatHandled) {
                heartbeatHandled = true;
                joinedNames = data.joinedNames;
                setJoinedNames();
                if (data.id) {
                    $('input#link')[0].value = 'https://www.youtube.com/watch?v=' + data.id;
                    showVideo();
                    player.cueVideoById(data.id, data.currentTime);
                    if (data.isPlaying) player.playVideo();
                    else player.pauseVideo();
                }
            }
        }

        function handleConnect() {
            $('button#submit').on('click', setVideo);
            $('button#home').on('click', goHome);
            $('button#join').on('click', joinSession);

            socket.on('upload_video', uploadVideo);
            socket.on('change_video_state', changeVideoState);
            socket.on('join', handleJoin);
            socket.on('leave', handleLeave);
            socket.on('get_heartbeat', handleHeartbeat);
        }

        var socket;
        function onPlayerReady(event) {
            socket = io(baseUrl, { transports: ['websocket', 'polling'] });
            socket.on('connect', handleConnect);

            $(window).bind('beforeunload', function() {
                socket.emit('leave', { sessionId: sessionId, clientId: clientId });
                return 'Are you sure you want to leave?';
            });
        }

        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                socket.emit('change_video', { sessionId: sessionId, isPlaying: true, currentTime: player.getCurrentTime() });
            } else if (event.data == YT.PlayerState.PAUSED) {
                socket.emit('change_video', { sessionId: sessionId, isPlaying: false, currentTime: player.getCurrentTime() });
            }
        }

        // Load YouTube Iframe API
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('video', {
                height: '100%',
                width: '100%',
                videoId: '',
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        }

        $(document).ready(function() {
            showVideo(false);
            showJoin(true);
            $('#room-title').text('Room ' + sessionId);
            $('input#post-shortlink')[0].value = window.location.href;
            $('input#client-id')[0].value = getRandomName();
            new Clipboard('#copy-button');
        });
    </script>
</body>
</html>
