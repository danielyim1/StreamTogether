<!DOCTYPE html>
<html>

<head>
  <!-- https://stackoverflow.com/questions/42601478/flask-calling-python-function-on-button-onclick-event -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
  <script type=text/javascript>
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const sessionId = urlParams.get('id');// get url

      var baseUrl;
      if (location.port) {
          baseUrl = "http://" + document.domain + ":" + location.port;
      } else {
          baseUrl = "https://" + document.domain;
      }

      //https://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript
      const clientId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      var videoShown = false;
      var ignoreStateChange = false;

      function showVideo() {
        if (!videoShown) {
          videoShown = true;
          document.getElementById("video").style.display = "block";
        }
      }

      function setVideo() {
        socket.emit("set_video", sessionId, $('input#link')[0].value);
        showVideo();
        ignoreStateChange = true; 
      }

      function uploadVideo(video_id) {
        if (video_id == 'Invalid') {
            alert("Invalid Youtube URL");
        } else {
          showVideo();
          ignoreStateChange = true; 
          player.loadVideoById(video_id);
        }
      }

      function changeVideoState(isPlaying,currentTime) {
        // console.log("video is started");
        if (player.getPlayerState() == YT.PlayerState.PAUSED && isPlaying)  {
          showVideo();
          player.seekTo(currentTime,true);
          player.playVideo();
        }
        else if (player.getPlayerState() == YT.PlayerState.PLAYING && !isPlaying) {
          showVideo();
          player.seekTo(currentTime,true);
          player.pauseVideo();
        }
      }

      function handle_message(message) {
        console.log(message);
      }

      function goHome() {
        window.location.href = baseUrl;
      }
      
      function handleConnect() {
        console.log("user is connected");
        $('button#submit').on('click',setVideo);
        $('button#home').on('click', goHome);

        socket.on('upload_video',uploadVideo);
        socket.on('change_video_state',changeVideoState);
        socket.on('message',handle_message);

        socket.emit('join', sessionId, clientId);
      }

      var socket;
      function onPlayerReady(event) {
        console.log("on player ready");
        socket = io.connect(baseUrl);
        socket.on('connect', handleConnect);

        $(window).bind('beforeunload', function(){
          socket.emit('leave', sessionId, clientId);
          return 'Are you sure you want to leave?';
        });
      }

      function onPlayerStateChange(event) {
        if (ignoreStateChange) {
          ignoreStateChange = false;
          return;
        }
        console.log(event);
        if (event.data == YT.PlayerState.PLAYING) {
          socket.emit('change_video',sessionId,true,event.target.getCurrentTime());
        }
        else if (event.data == YT.PlayerState.PAUSED) {
          socket.emit('change_video',sessionId,false,event.target.getCurrentTime());
        }
      }

      // Imports the youtube api script
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '100%',
          width: '100%',
          videoId: 'M7lc1UVf-VE',
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }

      $(document).ready(function() {
        document.getElementById("video").style.display = "none";
      });
    </script>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"
    integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/mystyle.css') }}">

</head>

<body>

  <div class="text-center">
    <button class="btn shadow-none text-center" id="home">
      <h1>Stream Together</h1>
    </button>
  </div>
  <br />

  <div class="input-group mb-3 margin">
    <input type="text" id="link" name="link" class="form-control" placeholder="Type in YouTube link here...">
    <div class="input-group-append">
      <button id=submit class="btn btn-primary align-middle">Submit</button>
    </div>
  </div>
  <br />

  <div class="embedded-video-16-9 margin" id="video">
    <div id="player"></div>
  </div>
</body>

</html>